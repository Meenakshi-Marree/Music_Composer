<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whispers of the Wires - AI Music Composer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            min-height: 100vh;
            position: relative;
        }

        #network-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            filter: blur(0.5px);
            opacity: 0.7;
        }

        .network-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
            width: 150%;
            height: 150%;
            position: absolute;
            top: -25%;
            left: -25%;
            animation: network-float 45s infinite linear;
        }

        @keyframes network-float {
            0% { transform: translate(0, 0); }
            50% { transform: translate(-15%, -15%); }
            100% { transform: translate(0, 0); }
        }

        .network-node {
            width: 4px;
            height: 4px;
            background-color: #22d3ee;
            border-radius: 50%;
            box-shadow: 0 0 10px #22d3ee, 0 0 5px #22d3ee;
            opacity: 0.8;
            animation: node-pulse 3s infinite alternate ease-in-out;
        }

        @keyframes node-pulse {
            0% { opacity: 0.6; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.5); }
        }

        .loading-bar {
            background-color: #22d3ee;
            animation: pulse-height 1.5s infinite ease-in-out;
            border-radius: 9999px;
        }
        .loading-bar:nth-child(2) { animation-delay: 0.1s; }
        .loading-bar:nth-child(3) { animation-delay: 0.2s; }
        .loading-bar:nth-child(4) { animation-delay: 0.3s; }
        .loading-bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes pulse-height {
            0%, 100% { transform: scaleY(0.4); opacity: 0.6; }
            50% { transform: scaleY(1); opacity: 1; }
        }

        .wave-bar {
            width: 2px;
            height: 4px;
            background-color: #38bdf8;
            margin-right: 1px;
            border-radius: 9999px;
            transition: height 0.1s ease-out;
        }

        .rating-star {
            cursor: pointer;
            transition: color 0.2s;
            font-size: 2rem;
            color: #4b5563;
            margin: 0 4px;
        }
        .rating-star.active {
            color: #fcd34d;
        }

        #generate-btn {
            background-image: linear-gradient(to right, #14b8a6, #22d3ee);
            transition: transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        #generate-btn:hover:enabled {
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(34, 211, 238, 0.3), 0 4px 6px -4px rgba(34, 211, 238, 0.2);
        }
        #generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-image: linear-gradient(to right, #6b7280, #9ca3af);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 pt-8 pb-16">

    <nav class="fixed top-0 left-0 w-full bg-gray-900/90 backdrop-blur-md z-50 shadow-md">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <a href="/" class="text-cyan-400 font-bold text-xl">AI Based Music Composition System</a>
                </div>
                <div class="hidden md:flex space-x-6">
                    <a href="/" class="text-gray-300 hover:text-cyan-400 font-medium transition">Home</a>
                    <a href="/compose" class="text-gray-300 hover:text-cyan-400 font-medium transition">Compose</a>
                    <a href="/library" class="text-gray-300 hover:text-cyan-400 font-medium transition">Library</a>
                    <a href="/playlist" class="text-gray-300 hover:text-cyan-400 font-medium transition">Playlist</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="pt-24 w-full flex flex-col items-center">
        <div id="network-background">
            <div class="network-grid"></div>
        </div>

        <div class="w-full max-w-3xl bg-gray-800/90 backdrop-blur-sm p-8 rounded-2xl shadow-2xl transition-all duration-300 border border-gray-700/50 relative z-10">
            
            <header class="text-center mb-6">
                <h1 class="text-3xl font-extrabold text-white mb-2">
                    <span class="text-cyan-400">AI</span> Music Composer
                </h1>
                <p class="text-gray-400 text-sm">Whisper of the Wires - Generate tracks up to 15 seconds.</p>
            </header>

            <form id="music-form">
                <div class="space-y-6">
                    <div>
                        <label for="genre" class="block text-sm font-medium text-gray-300 mb-2">Select Primary Genre</label>
                        <select id="genre" class="w-full p-3 bg-gray-700/70 text-white rounded-lg border border-gray-600 focus:ring-cyan-500 focus:border-cyan-500 transition duration-150">
                            <option value="blues">Blues</option>
                            <option value="classical">Classical</option>
                            <option value="country">Country</option>
                            <option value="disco">Disco</option>
                            <option value="hiphop">Hip Hop</option>
                            <option value="jazz">Jazz</option>
                            <option value="metal">Metal</option>
                            <option value="pop" selected>Pop</option>
                            <option value="reggae">Reggae</option>
                            <option value="rock">Rock</option>
                        </select>
                    </div>

                    <div>
                        <label for="prompt" class="block text-sm font-medium text-gray-300 mb-2">Music Description (Mood, Instruments, Tempo)</label>
                        <div class="relative">
                            <input type="text" id="prompt" value="a jazz piano melody with a warm kick drum and vinyl crackle." placeholder="e.g., soaring strings and deep, echoing horns in a minor key." 
                                class="w-full p-3 pr-12 bg-gray-700/70 text-white rounded-lg border border-gray-600 focus:ring-cyan-500 focus:border-cyan-500 transition duration-150" required>
                            <button type="button" id="copy-prompt-btn" title="Copy Prompt"
                                class="absolute right-0 top-0 mt-2 mr-2 p-1.5 text-gray-400 hover:text-cyan-400 rounded-lg transition duration-150">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v4a1 1 0 01-1 1H4m4-1H4m4 0l1 1v1m0-1V7a2 2 0 012-2h4a2 2 0 012 2v4a1 1 0 01-1 1h-3m-3-1H7m-1 0a2 2 0 002 2h4a2 2 0 002-2v-4a2 2 0 00-2-2h-4a2 2 0 00-2 2v4z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                        <label for="duration" class="text-sm font-medium text-gray-300 w-full sm:w-auto">Track Duration (Seconds):</label>
                        <div class="flex items-center space-x-3 w-full sm:w-1/2">
                            <input type="range" id="duration" min="3" max="15" value="5" step="1" 
                                class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            <span id="duration-value" class="text-lg font-bold text-cyan-400 w-10 text-right">5</span>
                        </div>
                    </div>

                    <div class="flex justify-end items-center">
                        <button type="button" id="inspire-btn" 
                                class="text-sm font-semibold px-4 py-2 bg-gray-700/50 text-gray-300 rounded-lg hover:bg-gray-700 hover:text-white transition duration-200">
                            ✨ Inspire Me (Random Prompt)
                        </button>
                    </div>

                    <div class="mt-6 h-10 flex items-center justify-center">
                        <p id="status-message" class="text-sm font-medium text-cyan-400/80 hidden">Waiting for input...</p>
                    </div>
                    
                    <div id="loading-animation" class="hidden flex items-end justify-center h-16 space-x-2">
                        <div class="loading-bar w-2 h-4"></div>
                        <div class="loading-bar w-2 h-6"></div>
                        <div class="loading-bar w-2 h-8"></div>
                        <div class="loading-bar w-2 h-6"></div>
                        <div class="loading-bar w-2 h-4"></div>
                    </div>
                </div>

                <button type="submit" id="generate-btn" 
                        class="w-full mt-8 p-4 text-lg font-semibold text-gray-900 rounded-xl hover:text-white transition-all duration-200">
                    Generate Composition
                </button>
            </form>

            <div id="results-section" class="mt-10 pt-6 border-t border-gray-700 space-y-6 hidden">
                <h2 class="text-2xl font-bold text-white text-center">New Track Generated</h2>

                <div class="flex flex-col items-center">
                    <p class="text-gray-400 mb-2 text-sm">Playback Wave Simulation (Press Play)</p>
                    <div id="playback-wave-container" class="flex justify-center items-center h-16 w-full overflow-hidden p-2 bg-gray-700/50 rounded-lg"></div>
                </div>

                <audio id="audio-player" controls class="w-full rounded-lg bg-gray-700"></audio>

                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <a id="download-link" href="#" download="ai_composition.wav" 
                       class="flex-1 text-center p-3 text-sm font-semibold text-white bg-teal-500 hover:bg-teal-600 rounded-lg transition duration-200 shadow-md">
                        Download Track
                    </a>
                </div>

                <div id="feedback-section" class="pt-6 border-t border-gray-700 text-center space-y-4">
                    <h3 class="text-xl font-bold text-white">Rate the Composition</h3>
                    <p class="text-gray-400 text-sm">Your rating is for display and testing only.</p>
                    <div id="rating-stars" class="flex justify-center text-4xl"></div>
                    <p id="rating-confirmation" class="text-sm font-medium text-cyan-400 hidden">Thank you for your feedback!</p>
                </div>
            </div>
        </div>
    </div>

    <script>
    // IndexedDB Helper Class
    class MusicDB {
        constructor() {
            this.dbName = 'AIComposerDB';
            this.version = 1;
            this.db = null;
        }

        async init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(this.dbName, this.version);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    this.db = request.result;
                    resolve(this.db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('tracks')) {
                        const objectStore = db.createObjectStore('tracks', { keyPath: 'id', autoIncrement: true });
                        objectStore.createIndex('genre', 'genre', { unique: false });
                        objectStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };
            });
        }

        async addTrack(track) {
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction(['tracks'], 'readwrite');
                const objectStore = transaction.objectStore('tracks');
                const request = objectStore.add(track);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const form = document.getElementById('music-form');
        const genreInput = document.getElementById('genre'); 
        const promptInput = document.getElementById('prompt');
        const durationInput = document.getElementById('duration');
        const durationValue = document.getElementById('duration-value');
        const generateBtn = document.getElementById('generate-btn');
        const statusMessage = document.getElementById('status-message');
        const loadingAnimation = document.getElementById('loading-animation');
        const resultsSection = document.getElementById('results-section');
        const audioPlayer = document.getElementById('audio-player');
        const downloadLink = document.getElementById('download-link');
        const playbackWaveContainer = document.getElementById('playback-wave-container');
        const ratingStarsContainer = document.getElementById('rating-stars');
        const ratingConfirmation = document.getElementById('rating-confirmation');
        const inspireBtn = document.getElementById('inspire-btn');
        const copyPromptBtn = document.getElementById('copy-prompt-btn');

        let waveInterval = null;
        let currentRating = 0;
        const API_URL = 'http://127.0.0.1:5000/generate-music';

        // Initialize IndexedDB
        const musicDB = new MusicDB();
        await musicDB.init();

        const randomPrompts = [
            { genre: "rock", description: "a heavy guitar riff with a four-on-the-floor drum beat and driving bass." },
            { genre: "metal", description: "a high-gain metal riff with distorted guitars, double kick drums, and a powerful breakdown." },
            { genre: "classical", description: "a soaring violin melody over a gentle piano accompaniment in a dramatic minor key." },
            { genre: "jazz", description: "a smooth trumpet solo over a walking bass line and swinging drums." },
            { genre: "hiphop", description: "a groovy, relaxed beat with a clean hip-hop drum break and a simple electric guitar riff." },
            { genre: "country", description: "a simple acoustic guitar progression with a slide guitar lead and a soft rhythm." },
            { genre: "pop", description: "an upbeat synth melody with a catchy chorus rhythm and clean vocal textures." },
            { genre: "reggae", description: "a relaxed, off-beat guitar chop with a deep bass line and slow, steady drums." }
        ];

        const grid = document.querySelector('.network-grid');
        for (let i = 0; i < 100; i++) {
            const cell = document.createElement('div');
            cell.className = 'flex justify-center items-center';
            const node = document.createElement('div');
            node.className = 'network-node';
            cell.appendChild(node);
            grid.appendChild(cell);
        }

        durationInput.addEventListener('input', () => durationValue.textContent = durationInput.value);

        const NUM_WAVE_BARS = 100;
        for (let i = 0; i < NUM_WAVE_BARS; i++) {
            const bar = document.createElement('div');
            bar.className = 'wave-bar';
            playbackWaveContainer.appendChild(bar);
        }
        const waveBars = document.querySelectorAll('.wave-bar');

        const startWaveAnimation = () => {
            if (waveInterval) clearInterval(waveInterval);
            waveInterval = setInterval(() => {
                waveBars.forEach(bar => {
                    bar.style.height = `${Math.random() * 16 + 4}px`;
                });
            }, 100);
        };
        const stopWaveAnimation = () => { clearInterval(waveInterval); };

        const NUM_STARS = 5;
        for (let i = 0; i < NUM_STARS; i++) {
            const star = document.createElement('span');
            star.className = 'rating-star';
            star.innerHTML = '★';
            star.dataset.index = i + 1;
            star.addEventListener('click', () => setRating(i + 1));
            ratingStarsContainer.appendChild(star);
        }
        const setRating = (rating) => {
            currentRating = rating;
            ratingStarsContainer.querySelectorAll('.rating-star').forEach((star, idx) => {
                star.classList.toggle('active', idx < rating);
            });
            ratingConfirmation.classList.remove('hidden');
            ratingConfirmation.textContent = `You rated this track ${rating}/5 ⭐`;
        };

        inspireBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const random = randomPrompts[Math.floor(Math.random() * randomPrompts.length)];
            genreInput.value = random.genre;
            promptInput.value = random.description;
            promptInput.focus();
            statusMessage.textContent = `Loaded random prompt!`;
            statusMessage.classList.remove('hidden','text-red-400');
            statusMessage.classList.add('text-cyan-400');
        });

        copyPromptBtn.addEventListener('click', () => {
            const fullPrompt = `${genreInput.value}, ${promptInput.value.trim()}`;
            navigator.clipboard.writeText(fullPrompt)
                .then(() => {
                    statusMessage.textContent = 'Full prompt copied to clipboard!';
                    statusMessage.classList.remove('hidden','text-red-400');
                    statusMessage.classList.add('text-cyan-400');
                });
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            await generateMusic();
        });

        async function generateMusic() {
            generateBtn.disabled = true;
            resultsSection.classList.add('hidden');
            statusMessage.textContent = 'Generating music...';
            statusMessage.classList.remove('hidden','text-red-400');
            statusMessage.classList.add('text-cyan-400');
            loadingAnimation.classList.remove('hidden');

            try {
                const payload = {
                    genre: genreInput.value,
                    prompt: promptInput.value,
                    duration: parseInt(durationInput.value)
                };
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error('Server error');

                const data = await res.json();

                if (data.status !== "success") throw new Error(data.error || "Generation failed");

                const audioURL = `data:${data.mime_type};base64,${data.audio_base64}`;

                audioPlayer.src = audioURL;
                downloadLink.href = audioURL;
                resultsSection.classList.remove('hidden');

                startWaveAnimation();

                // Convert base64 to Blob for IndexedDB storage
                const byteCharacters = atob(data.audio_base64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const audioBlob = new Blob([byteArray], { type: data.mime_type });

                // Save to IndexedDB
                const track = {
                    genre: genreInput.value,
                    description: promptInput.value,
                    duration: parseInt(durationInput.value),
                    audioBlob: audioBlob,
                    timestamp: Date.now()
                };
                
                await musicDB.addTrack(track);
                statusMessage.textContent = 'Track saved successfully! ✅';

            } catch (err) {
                console.error(err);
                statusMessage.textContent = 'Error generating music!';
                statusMessage.classList.remove('hidden','text-cyan-400');
                statusMessage.classList.add('text-red-400');
            } finally {
                generateBtn.disabled = false;
                loadingAnimation.classList.add('hidden');
            }
        }
    });
    </script>
</body>
</html>